---
title: "McCann *et al* 2018: Post-FMT viral taxa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      dev = "svg")
library(dplyr)
library(tidyverse)
library(magrittr)
library(ggplot2)
library(viridis)
library(vegan)
library(stringr)

 
taxa_ranks <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

theme_scatterplot = theme_classic(base_size = 18) + theme(
  line = element_line(size=0.8),
  text = element_text(color = "black"),
  axis.text.x = element_text(color="black"),
  axis.text.y = element_text(color="black")
)


# Make sure Snakemake handles accessible
stopifnot(exists("snakemake"))
```

## Background

This report uses the [Sunbeam pipeline](https://github.com/sunbeam-labs/sunbeam) to reproduce findings from "Viromes of one year old infants reveal the impact of birth mode on microbiome diversity" [(PMID: 29761040)](https://www.ncbi.nlm.nih.gov/pubmed/29761040) by Zuo *et al*. A key finding of this study is that the virome at 1 y/o seems to correlate with the birth mode--that is, that children born by spontaneous vaginal delivery (SVD) have higher viral diversity and higher *Anelloviridae* richness than children born by C-section. The purpose of this report is to see whether analysis with Sunbeam reproduces these results. This report was generated by the extension [sbx_mccann2018](https://github.com/louiejtaylor/sbx_mccann2018); this link also includes instructions for re-running this analysis from the beginning. This report was run using the Kraken Standard database built 1 October, 2018.

```{r paths}
metadata_file <- file.path(snakemake@params[['metadata_file']])
kraken_file <- file.path(snakemake@input[['kraken']])
```

```{r metadata-and-classification}
md = read.table(metadata_file, sep = "\t", header = TRUE)
kraken <- read.table(kraken_file, header = TRUE, skip = 1, sep = '\t', comment.char = '~')
```
## Results

Below are boxplots generated using the `ggplot2` package in R. Each point corresponds to a single sample. We want to see whether we also find greater Anellovirus richness in spontaneous vaginal delivery (SVD) compared to C-section, and greater overall virus diversity in SVD compared to C-section:

```{r kraken-setup, fig.width=6, fig.height=4}

# Hits
kraken_tax_viruses <- tidyr::separate(kraken, Consensus.Lineage, into=taxa_ranks, sep="; ", extra="drop", fill="right") %>%
  dplyr::mutate_at(vars(Kingdom:Species), funs(sub("[kpcofgs]__", "", .))) %>%
  dplyr::mutate_at(vars(Kingdom:Species), funs(ifelse(.=="", NA, .))) %>%
  subset(Kingdom == "Viruses")

# Anelloviridae diversity (# unique Anelloviridae)

anellos <- subset(kraken_tax_viruses, Family == "Anelloviridae")
count_positivity <- function(l) {
  return(sum(l > 0))
}
anello_summary <- as.data.frame(t(as.data.frame(lapply(anellos[,2:41], count_positivity), row.names = c("unique_anellos")))) %$%
  dplyr::mutate(.,Run=gsub(".taxa", "", row.names(.), fixed = TRUE))

# Virome diversity

virus_sample <- dplyr::select(kraken_tax_viruses, -c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "X.OTU.ID")) %$%
  as.data.frame(t(.)) %$%
  vegan::rrarefy(., sample = 100)

virus_shan_div <- as.data.frame(vegan::diversity(virus_sample, index = "shannon"))

samp <- row.names(virus_shan_div)
colnames(virus_shan_div) <- c("shannon")
virus_shan_div <- dplyr::mutate(virus_shan_div, Run = gsub(".taxa", "", samp, fixed = TRUE)) 

# Agglomerate

hit_summary <- as.data.frame(t(as.data.frame(lapply(kraken_tax_viruses[,2:41], sum), row.names = c("total_virus_reads")))) %$%
  dplyr::mutate(.,Run=gsub(".taxa", "", row.names(.), fixed = TRUE)) %>% 
  inner_join(md, by = "Run") %>%
  inner_join(anello_summary, by = "Run") %>%
  inner_join(virus_shan_div, by = "Run") %>%
  subset(Subgroup %in% c("CS-FT", "SVD"))
```

### Anellovirus richness

```{r plot-anellos}
# plot anellos
ggplot(data = hit_summary, aes(x = Subgroup, y= unique_anellos))+
  geom_boxplot(aes(fill = Subgroup)) + 
  geom_point(shape = 21, size = 2, aes(fill = Subgroup)) + 
  scale_fill_manual(values = c("dodgerblue3", "goldenrod")) +
  scale_x_discrete(labels = c("C-section", "SVD")) +
  guides(fill = FALSE) + 
  theme_scatterplot + labs(x = "Group", y ="Anellovirus species")

p_anellos <- wilcox.test(x = subset(hit_summary, Subgroup == "CS-FT")$unique_anellos,
            y = subset(hit_summary, Subgroup == "SVD")$unique_anellos)

```

### Virus diversity

```{r plot-diversity}
# plot diversity
ggplot(data = hit_summary, aes(x = Subgroup, y = shannon))+
  geom_boxplot(aes(fill = Subgroup)) + 
  geom_point(shape = 21, size = 2, aes(fill = Subgroup)) + 
  scale_fill_manual(values = c("dodgerblue3", "goldenrod")) +
  scale_x_discrete(labels = c("C-section", "SVD")) +
  guides(fill = FALSE) + 
  theme_scatterplot + labs(x = "Group", y ="Shannon diversity")

p_shan <- wilcox.test(x = subset(hit_summary, Subgroup == "CS-FT")$shannon,
            y = subset(hit_summary, Subgroup == "SVD")$shannon)
```


## Conclusion

The results of our analysis are comparable to those reported by McCann *et al*. The Wilcoxon rank-sum test p-value (p=`r format(p_anellos["p.value"])`) is similar to that reported in the paper (p=0.014). While the difference in viral diversity does not reach significance (p=`r format(p_shan["p.value"])`)), we do see the same relationship in Shannon diversity (higher diversity in SVD) as McCann *et al*. 
